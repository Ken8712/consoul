
本ドキュメントでは、Light／Echo（Echoes）および関連テーブルの設計をまとめています。

---

|key|name|r|g|b|a|
|---|---|---|---|---|---|
|philia|愛|255|48|255|205|
|hatred|憎しみ|255|0|0|255|
|joy|喜び|255|223|80|230|
|sadness|悲しみ|0|0|255|153|
|wonder|驚き|80|255|255|255|
|motive|欲望|0|255|0|255|

## 1. light_definitions テーブル
マスターとなる「light」（感情）定義を保持します。

```ruby
# db/migrate/20250627_create_light_definitions.rb
class CreateLightDefinitions < ActiveRecord::Migration[6.1]
  def change
    create_table :light_definitions do |t|
      t.string  :key,  null: false, limit: 191
      t.string  :name, null: false, limit: 191
      t.integer :r,    null: false
      t.integer :g,    null: false
      t.integer :b,    null: false
      t.integer :a,    null: false, default: 255
      t.timestamps
    end
    add_index :light_definitions, :key, unique: true
  end
end

```

### モデル定義
```ruby
# app/models/light_definition.rb
class LightDefinition < ApplicationRecord
  has_many :lights,      dependent: :destroy
  has_many :echo_lights, dependent: :destroy

  validates :key,  presence: true, uniqueness: true
  validates :name, presence: true
  validates :r, :g, :b, :a,
            numericality: { only_integer: true,
                            greater_than_or_equal_to: 0,
                            less_than_or_equal_to: 255 }

  # => "#RRGGBBAA"
  def hex_rgba
    "#%02X%02X%02X%02X" % [r, g, b, a]
  end
end

```

---

## 2. lights テーブル
ユーザーごとの「light_amount」（感情の累積数）を保持します。

```ruby
# db/migrate/20250627_create_lights.rb
class CreateLights < ActiveRecord::Migration[6.1]
  def change
    create_table :lights do |t|
      t.references :user,             null: false, foreign_key: true
      t.references :light_definition, null: false, foreign_key: true
      t.integer    :amount,            null: false, default: 0
      t.timestamps
    end
    add_index :lights, %i[user_id light_definition_id], unique: true
  end
end
```

### モデル定義
```ruby
class Light < ApplicationRecord
  belongs_to :user
  belongs_to :light_definition

  validates :amount, numericality: { greater_than_or_equal_to: 0 }
  validates :light_definition_id, uniqueness: { scope: :user_id }
end
```

---

## 3. echoes テーブル
ジャーナル（Echo）本体を保持します。

```ruby
# db/migrate/20250627_create_echoes.rb
class CreateEchoes < ActiveRecord::Migration[6.1]
  def change
    create_table :echoes do |t|
      t.references :user,        null: false, foreign_key: true
      t.string     :title,       null: false, limit: 191
      t.string     :pattern_name, limit: 191
      t.text      :input_data,    null: false, default: "{}"
      t.text      :response_data, null: false, default: "{}"
      t.timestamps
    end
  end
end
```

### モデル定義
```ruby
# app/models/echo.rb
class Echo < ApplicationRecord
  belongs_to :user
  has_many   :echo_lights,      dependent: :destroy
  has_many   :light_definitions, through: :echo_lights

  validates :title, presence: true
end
```

---

## 4. echo_lights テーブル
Echo と LightDefinition の中間テーブル（消費量を保持）。

```ruby
# db/migrate/20250627_create_echo_lights.rb
class CreateEchoLights < ActiveRecord::Migration[6.1]
  def change
    create_table :echo_lights do |t|
      t.references :echo,             null: false, foreign_key: true
      t.references :light_definition, null: false, foreign_key: true
      t.integer    :amount,           null: false
      t.timestamps
    end
    add_index :echo_lights, %i[echo_id light_definition_id], unique: true
  end
end
```

### モデル定義
```ruby
# app/models/echo_light.rb
class EchoLight < ApplicationRecord
  belongs_to :echo
  belongs_to :light_definition

  validates :amount, numericality: { greater_than: 1 }
  validates :light_definition_id, uniqueness: { scope: :echo_id }
end
```

---
## 4. 初期マスターデータ (シード)

```ruby
# db/seeds/light_definitions.rb
LightDefinition.create!([
  { key: 'philia',  name: '愛',     r: 255, g: 48,  b: 255, a: 205 },
  { key: 'hatred',  name: '憎しみ', r: 255, g: 0,   b: 0,   a: 255 },
  { key: 'joy',     name: '喜び',   r: 255, g: 223, b: 80,  a: 230 },
  { key: 'sadness', name: '悲しみ', r: 0,   g: 0,   b: 255, a: 153 },
  { key: 'wonder',  name: '驚き',   r: 80,  g: 255, b: 255, a: 255 },
  { key: 'motive',  name: '欲望',   r: 0,   g: 255, b: 0,   a: 255 }])

```
### 4-1. 一覧テーブル (ドキュメント用)

| key     | name | r   | g   | b   | a   |
| ------- | ---- | --- | --- | --- | --- |
| philia  | 愛    | 255 | 48  | 255 | 205 |
| hatred  | 憎しみ  | 255 | 0   | 0   | 255 |
| joy     | 喜び   | 255 | 223 | 80  | 230 |
| sadness | 悲しみ  | 0   | 0   | 255 | 153 |
| wonder  | 驚き   | 80  | 255 | 255 | 255 |
| motive  | 意欲   | 0   | 255 | 0   | 255 |
ERB利用例
<% LightDefinition.order(:id).each do |defn| %>
  <% amount = current_user.lights.find_by(light_definition: defn)&.amount || 0 %>
  <div class="light-badge" style="background-color: <%= defn.hex_rgba %>">
    <%= defn.name %> (<%= amount %>)
  </div>
<% end %>
